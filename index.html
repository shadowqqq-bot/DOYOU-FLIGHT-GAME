<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>김도유의 비행기 게임</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #0c0a18;
            color: white;
            overflow: hidden; /* 스크롤바 숨기기 */
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 800px;
            max-height: 100%; /* 모바일 화면 꽉 채우기 */
            box-shadow: 0 0 25px rgba(173, 216, 230, 0.5); /* 밝은 파랑 계열의 그림자 효과 */
            border-radius: 12px;
            overflow: hidden; /* 컨테이너 밖으로 나가는 요소 숨기기 */
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(#0c0a18, #2a2a72, #000000); /* 우주 느낌의 배경 */
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* UI 요소가 게임 클릭을 방해하지 않도록 설정 */
        }
        #game-stats {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        #score-display, #coin-display {
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
        #health-display {
            font-size: 1.8rem;
            letter-spacing: 0.2em;
        }
        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            pointer-events: auto; /* 모달 내 버튼 클릭이 가능하도록 설정 */
        }
        .modal-content {
            background: rgba(41, 41, 85, 0.9);
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #89a7ff;
            box-shadow: 0 0 20px rgba(137, 167, 255, 0.5);
        }
        #ranking-list {
            list-style-type: decimal;
            padding-left: 2.5rem;
            text-align: left;
            max-height: 40vh;
            overflow-y: auto;
        }
        #ranking-list li {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        #name-input, #new-name-input {
            pointer-events: auto;
            color: black;
        }
        /* 상점 스타일 */
        #skin-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            max-height: 50vh;
            overflow-y: auto;
            padding: 10px;
        }
        .skin-item {
            border: 2px solid #89a7ff;
            border-radius: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            text-align: center;
        }
        .skin-preview {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .skin-button { pointer-events: auto; }
        
        /* 스킬 선택 화면 스타일 */
        #skill-choices {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .skill-card {
            border: 2px solid #f1c40f;
            border-radius: 10px;
            padding: 20px;
            width: 180px;
            background: rgba(91, 9, 130, 0.5);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            pointer-events: auto;
        }
        .skill-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 0 15px #f1c40f;
        }
        .control-button {
            pointer-events: auto;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 640px) {
            .modal-content {
                padding: 20px;
                width: 90%;
            }
            #skill-choices {
                flex-direction: column;
                gap: 10px;
                max-height: 60vh;
                overflow-y: auto;
                padding-right: 10px;
            }
            .skill-card {
                width: 100%;
                padding: 15px;
            }
            .modal-content h1, .modal-content h2 {
                font-size: 2.2rem;
                line-height: 1.2;
            }
            .modal-content p {
                font-size: 1rem;
            }
            .modal-buttons {
                flex-direction: column;
                width: 100%;
            }
            .name-input-group {
                flex-direction: column;
                width: 100%;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div id="game-stats" class="hidden">
            <div id="score-display">점수: 0</div>
            <div id="coin-display">코인: 0</div>
            <div id="health-display"></div>
        </div>
        
        <!-- 이름 입력 화면 -->
        <div id="name-prompt-screen" class="modal hidden">
            <div class="modal-content">
                <h1 class="text-3xl sm:text-4xl font-bold mb-4">환영합니다!</h1>
                <p class="text-lg sm:text-xl mb-6">데이터 저장을 위해 사용할 이름을 입력해주세요.</p>
                <div class="flex items-center gap-2 name-input-group">
                    <input type="text" id="new-name-input" placeholder="이름" class="w-full px-4 py-2 rounded text-lg sm:text-xl text-center sm:text-left">
                    <button id="confirm-name-button" class="w-full px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-bold text-lg sm:text-xl">확인</button>
                </div>
            </div>
        </div>
        
        <!-- 로비 화면 -->
        <div id="lobby-screen" class="modal hidden">
            <div class="modal-content">
                <h1 class="text-4xl sm:text-5xl font-bold mb-4">김도유의 비행기 게임</h1>
                <p id="welcome-message" class="text-lg sm:text-xl mb-6"></p>
                <div id="lobby-coin-display" class="text-2xl mb-4"></div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="start-button" class="px-8 py-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-bold text-xl sm:text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                        게임 시작
                    </button>
                    <button id="shop-button" class="px-8 py-4 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-bold text-xl sm:text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                        상점
                    </button>
                    <button id="ranking-button-main" class="px-8 py-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-bold text-xl sm:text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                        랭킹
                    </button>
                </div>
            </div>
        </div>

        <!-- 게임 오버 화면 -->
        <div id="game-over-screen" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-4xl sm:text-5xl font-bold mb-4">게임 오버</h2>
                <p id="final-score" class="text-xl sm:text-2xl mb-2"></p>
                <p id="earned-coins" class="text-xl sm:text-2xl mb-6"></p>
                <div class="flex items-center gap-2 mb-4 name-input-group">
                    <input type="text" id="name-input" placeholder="이름 입력" class="w-full px-4 py-2 rounded text-lg sm:text-xl text-center sm:text-left" readonly>
                    <button id="save-score-button" class="w-full px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-bold text-lg sm:text-xl shadow-lg transition">랭킹 저장</button>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mt-4">
                    <button id="restart-button" class="px-8 py-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold text-xl sm:text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                        다시 시작
                    </button>
                    <button id="go-to-shop-button" class="px-8 py-4 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-bold text-xl sm:text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                        상점
                    </button>
                    <button id="go-to-lobby-button" class="px-8 py-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-bold text-xl sm:text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                        로비
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 랭킹 화면 -->
        <div id="ranking-screen" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-4xl sm:text-5xl font-bold mb-4">명예의 전당</h2>
                <ol id="ranking-list" class="mb-6"></ol>
                 <div class="flex flex-col sm:flex-row gap-4">
                    <button id="play-again-button" class="px-8 py-4 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold text-xl sm:text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                        다시 하기
                    </button>
                    <button id="main-menu-button" class="px-8 py-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-bold text-xl sm:text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                        로비로
                    </button>
                </div>
            </div>
        </div>

        <!-- 상점 화면 -->
        <div id="shop-screen" class="modal hidden">
            <div class="modal-content w-11/12 max-w-4xl">
                 <h2 class="text-4xl sm:text-5xl font-bold mb-4">스킨 상점</h2>
                 <div id="shop-coin-display" class="text-2xl mb-4"></div>
                 <div id="skin-list" class="mb-6"></div>
                 <button id="back-to-lobby-button" class="px-8 py-4 bg-gray-600 hover:bg-gray-700 rounded-lg text-white font-bold text-2xl shadow-lg transition duration-300 transform hover:scale-105">
                    로비로
                 </button>
            </div>
        </div>
        
        <!-- 스킬 선택 화면 -->
        <div id="skill-choice-screen" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-4xl sm:text-5xl font-bold mb-4">스킬 선택</h2>
                <p class="text-base sm:text-xl mb-6">보스를 처치했습니다! 보상으로 스킬 하나를 선택하세요.</p>
                <div id="skill-choices"></div>
            </div>
        </div>
        
        <!-- 모바일 컨트롤러 -->
        <div id="mobile-controls" class="absolute bottom-10 w-full flex justify-between items-end px-5 pointer-events-none hidden">
            <!-- Left controls -->
            <div class="flex gap-4">
                <button id="left-button" class="control-button text-3xl sm:text-4xl bg-white/20 backdrop-blur-sm rounded-full w-16 h-16 sm:w-20 sm:h-20">&lt;</button>
                <button id="right-button" class="control-button text-3xl sm:text-4xl bg-white/20 backdrop-blur-sm rounded-full w-16 h-16 sm:w-20 sm:h-20">&gt;</button>
            </div>

            <!-- Right controls -->
            <div>
                <button id="shoot-button" class="control-button text-4xl bg-red-500/40 backdrop-blur-sm rounded-full w-20 h-20 sm:w-24 sm:h-24">💥</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 초기 설정 ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const allScreens = document.querySelectorAll('.modal');

    const namePromptScreen = document.getElementById('name-prompt-screen');
    const lobbyScreen = document.getElementById('lobby-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const rankingScreen = document.getElementById('ranking-screen');
    const shopScreen = document.getElementById('shop-screen');
    const skillChoiceScreen = document.getElementById('skill-choice-screen');
    
    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');
    const rankingButtonMain = document.getElementById('ranking-button-main');
    const shopButton = document.getElementById('shop-button');
    const saveScoreButton = document.getElementById('save-score-button');
    const playAgainButton = document.getElementById('play-again-button');
    const mainMenuButton = document.getElementById('main-menu-button');
    const backToLobbyButton = document.getElementById('back-to-lobby-button');
    const confirmNameButton = document.getElementById('confirm-name-button');
    const goToShopButton = document.getElementById('go-to-shop-button');
    const goToLobbyButton = document.getElementById('go-to-lobby-button');
    
    const mobileControls = document.getElementById('mobile-controls');
    const leftButton = document.getElementById('left-button');
    const rightButton = document.getElementById('right-button');
    const shootButton = document.getElementById('shoot-button');
    
    const nameInput = document.getElementById('name-input');
    const newNameInput = document.getElementById('new-name-input');
    const rankingList = document.getElementById('ranking-list');
    const skinList = document.getElementById('skin-list');
    const skillChoicesContainer = document.getElementById('skill-choices');
    
    const gameStats = document.getElementById('game-stats');
    const scoreDisplay = document.getElementById('score-display');
    const coinDisplay = document.getElementById('coin-display');
    const welcomeMessage = document.getElementById('welcome-message');
    const lobbyCoinDisplay = document.getElementById('lobby-coin-display');
    const shopCoinDisplay = document.getElementById('shop-coin-display');
    const healthDisplay = document.getElementById('health-display');
    const finalScoreDisplay = document.getElementById('final-score');
    const earnedCoinsDisplay = document.getElementById('earned-coins');

    let animationFrameId;
    let score, coins, currentRoundCoins;
    let gameOver, gamePaused;
    let keys = {};
    let player;
    let bullets, enemies, enemyBullets, bossBullets, itemCoins, healthPacks;
    let enemySpawnTimer, stars, shootCooldown;
    let spacebarHoldStart = 0;
    let isLaserActive = false, laserEndTime = 0, laserCooldownEndTime = 0;
    
    let boss = null;
    let bossSpawned = false, superBossSpawned = false;
    let currentPlayer = '';

    // --- 스킨 데이터 ---
    const skins = [
        { id: 'default', name: '기본 비행기', price: 0, draw: (ctx, x, y, w, h) => { 
            ctx.fillStyle = '#9EADC8'; ctx.beginPath(); ctx.moveTo(x + w * 0.5, y); ctx.lineTo(x + w, y + h * 0.8); ctx.lineTo(x + w * 0.8, y + h); ctx.lineTo(x + w * 0.2, y + h); ctx.lineTo(x, y + h * 0.8); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#475569'; ctx.fillRect(x + w * 0.4, y + h * 0.6, w * 0.2, h * 0.4);
            ctx.fillStyle = '#60A5FA'; ctx.beginPath(); ctx.moveTo(x + w * 0.5, y + h * 0.1); ctx.bezierCurveTo(x + w * 0.7, y + h * 0.4, x + w * 0.3, y + h * 0.4, x + w * 0.5, y + h * 0.1); ctx.fill();
        } },
        { id: 'red_comet', name: '레드 코멧', price: 5000, draw: (ctx, x, y, w, h) => {
            ctx.fillStyle = '#DC2626'; ctx.beginPath(); ctx.moveTo(x + w * 0.5, y); ctx.lineTo(x + w, y + h); ctx.lineTo(x + w * 0.5, y + h * 0.8); ctx.lineTo(x, y + h); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#450A0A'; ctx.beginPath(); ctx.moveTo(x + w * 0.5, y + h * 0.4); ctx.lineTo(x + w * 0.7, y + h * 0.7); ctx.lineTo(x + w * 0.3, y + h * 0.7); ctx.closePath(); ctx.fill();
        } },
        { id: 'green_arrow', name: '그린 애로우', price: 10000, draw: (ctx, x, y, w, h) => {
            ctx.fillStyle = '#16A34A'; ctx.beginPath(); ctx.moveTo(x + w * 0.5, y); ctx.lineTo(x + w, y + h); ctx.lineTo(x + w * 0.5, y + h * 0.85); ctx.lineTo(x, y + h); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#FBBF24'; ctx.beginPath(); ctx.moveTo(x, y + h); ctx.lineTo(x + w * 0.2, y + h * 0.8); ctx.lineTo(x + w * 0.8, y + h * 0.8); ctx.lineTo(x + w, y + h); ctx.closePath(); ctx.fill();
        } },
        { id: 'gold_ship', name: '황금선', price: 50000, draw: (ctx, x, y, w, h) => {
            ctx.fillStyle = '#FACC15'; ctx.beginPath(); ctx.moveTo(x + w / 2, y); ctx.lineTo(x, y + h*0.4); ctx.lineTo(x, y + h); ctx.lineTo(x + w, y + h); ctx.lineTo(x+w, y+h*0.4); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#B45309'; ctx.beginPath(); ctx.moveTo(x + w / 2, y + h * 0.2); ctx.lineTo(x + w * 0.2, y + h); ctx.lineTo(x + w * 0.8, y + h); ctx.closePath(); ctx.fill();
        } },
        { id: 'starlight_phantom', name: '별빛 유령', price: 100000, draw: (ctx, x, y, w, h) => {
            ctx.fillStyle = '#4338CA'; ctx.beginPath(); ctx.moveTo(x + w * 0.5, y); ctx.lineTo(x + w, y + h * 0.6); ctx.lineTo(x + w * 0.5, y + h); ctx.lineTo(x, y + h * 0.6); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#A78BFA'; ctx.fillRect(x + w * 0.45, y, w * 0.1, h);
            ctx.fillStyle = 'white'; for(let i=0; i<3; i++) { ctx.beginPath(); ctx.arc(x + w*(Math.random()*0.6+0.2), y + h*(Math.random()*0.6+0.2), w*0.03, 0, Math.PI*2); ctx.fill(); }
        }},
        { id: 'galactic_overlord', name: '은하계 군주', price: 200000, draw: (ctx, x, y, w, h) => {
            ctx.fillStyle = '#1E293B'; ctx.beginPath(); ctx.moveTo(x + w * 0.5, y); ctx.lineTo(x + w, y + h); ctx.lineTo(x, y + h); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#F59E0B'; ctx.beginPath(); ctx.moveTo(x + w * 0.5, y + h*0.2); ctx.lineTo(x + w, y + h); ctx.lineTo(x + w * 0.7, y + h); ctx.lineTo(x + w*0.5, y+h*0.5); ctx.lineTo(x + w * 0.3, y + h); ctx.lineTo(x, y + h); ctx.closePath(); ctx.fill();
        }}
    ];
    let ownedSkins = ['default'], equippedSkin = 'default';

    // --- 스킬 데이터 ---
    const skills = [
        { id: 'damage_up', name: '공격력 강화', description: '총알의 공격력이 2배가 됩니다.' },
        { id: 'fire_rate_up', name: '연사 속도 증가', description: '총알 발사 속도가 2배 빨라집니다.' },
        { id: 'shield', name: '보호막', description: '적의 공격을 1회 막아주는 보호막을 얻습니다.' },
        { id: 'pierce_shot', name: '관통탄', description: '총알이 적을 관통합니다.'},
        { id: 'extra_life', name: '추가 생명', description: '최대 체력과 현재 체력이 1 증가합니다.'}
    ];

    // --- 게임 데이터 관리 ---
    function getAllGameData() { return JSON.parse(localStorage.getItem('airplane_all_users') || '{}'); }
    function loadGameData() {
        currentPlayer = localStorage.getItem('airplane_current_user');
        if (!currentPlayer) {
            namePromptScreen.classList.remove('hidden');
            return;
        }
        
        const allData = getAllGameData();
        const playerData = allData[currentPlayer];
        
        coins = playerData.coins;
        ownedSkins = playerData.ownedSkins;
        equippedSkin = playerData.equippedSkin;

        welcomeMessage.textContent = `${currentPlayer}님, 환영합니다!`;
        nameInput.value = currentPlayer;
        updateCoinDisplays();
        lobbyScreen.classList.remove('hidden');
    }
    function saveGameData() {
        if (!currentPlayer) return;
        const allData = getAllGameData();
        allData[currentPlayer] = {
            coins: coins,
            ownedSkins: ownedSkins,
            equippedSkin: equippedSkin
        };
        localStorage.setItem('airplane_all_users', JSON.stringify(allData));
    }
    
    function confirmName() {
        const name = newNameInput.value.trim();
        if (!name) { alert('이름을 입력해주세요!'); return; }
        
        currentPlayer = name;
        localStorage.setItem('airplane_current_user', currentPlayer);
        
        const allData = getAllGameData();
        if (!allData[currentPlayer]) { // New player
            coins = 0;
            ownedSkins = ['default'];
            equippedSkin = 'default';
            saveGameData();
        }
        
        namePromptScreen.classList.add('hidden');
        loadGameData();
    }
    
    function updateCoinDisplays() {
        const formattedCoins = (coins + (currentRoundCoins || 0)).toLocaleString();
        lobbyCoinDisplay.textContent = `💰 보유 코인: ${coins.toLocaleString()}`;
        shopCoinDisplay.textContent = `💰 보유 코인: ${coins.toLocaleString()}`;
        coinDisplay.textContent = `코인: ${formattedCoins}`;
    }

    // --- 게임 객체 클래스 ---
    class Player {
        constructor(x, y, w, h, speed) {
            this.x = x; this.y = y; this.width = w; this.height = h;
            this.speed = speed;
            this.health = 3; this.maxHealth = 3;
            this.bulletDamage = 1; this.shootCooldownFrames = 10;
            this.hasShield = false; this.pierceShot = false;
            this.coinMultiplier = 1;
        }
        draw() {
            const skin = skins.find(s => s.id === equippedSkin);
            if (skin) skin.draw(ctx, this.x, this.y, this.width, this.height);
            if (this.hasShield) {
                ctx.strokeStyle = '#3498db'; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.arc(this.x + this.width / 2, this.y + this.height / 2, this.width / 2 + 10, 0, Math.PI * 2);
                ctx.stroke();
            }
        }
        update() {
            if (keys['ArrowLeft'] && this.x > 0) this.x -= this.speed;
            if (keys['ArrowRight'] && this.x < canvas.width - this.width) this.x += this.speed;
            this.draw();
        }
        takeDamage() {
            if (this.hasShield) { this.hasShield = false; return; }
            this.health--;
            updateHealthDisplay();
        }
    }

    class Bullet {
        constructor(x, y, w, h, speed, color) {
            this.x = x; this.y = y; this.width = w; this.height = h;
            this.speed = speed; this.color = color;
        }
        draw() {
            ctx.fillStyle = this.color; ctx.shadowBlur = 10; ctx.shadowColor = this.color;
            ctx.fillRect(this.x, this.y, this.width, this.height); ctx.shadowBlur = 0;
        }
        update() { this.y += this.speed; }
    }

    class Enemy {
        constructor(x, y, w, h, speed, health, color) {
            this.x = x; this.y = y; this.width = w; this.height = h;
            this.speed = speed; this.health = health; this.color = color;
            this.dx = (Math.random() - 0.5) * 3; this.laserHitCooldown = 0;
        }
        draw() {
            const x = this.x, y = this.y, w = this.width, h = this.height;
            ctx.fillStyle = this.color; ctx.beginPath();
            ctx.moveTo(x + w * 0.5, y); ctx.lineTo(x + w, y + h * 0.5); ctx.lineTo(x + w * 0.8, y + h);
            ctx.lineTo(x + w * 0.2, y + h); ctx.lineTo(x, y + h * 0.5);
            ctx.closePath(); ctx.fill();
            const eyeColor = this.width > 50 ? '#FBBF24' : '#FDE047';
            ctx.fillStyle = eyeColor; ctx.beginPath();
            ctx.arc(x + w * 0.5, y + h * 0.4, w * 0.1, 0, Math.PI * 2); ctx.fill();
        }
        update() {
            this.y += this.speed; this.x += this.dx;
            if (this.laserHitCooldown > 0) this.laserHitCooldown--;
            if (this.x <= 0 || this.x + this.width >= canvas.width) this.dx *= -1;
            if (Math.random() < 0.005 && this.y > 0 && this.y < canvas.height / 2) this.shoot();
        }
        shoot() {
            const bulletX = this.x + this.width / 2 - 3; const bulletY = this.y + this.height;
            enemyBullets.push(new Bullet(bulletX, bulletY, 6, 12, 4, '#9b59b6'));
        }
    }

    class Boss {
        constructor(x, y, w, h, speed, health) {
            this.x = x; this.y = y; this.width = w; this.height = h;
            this.speed = speed; this.health = health; this.maxHealth = health;
            this.dx = speed; this.shootTimer = 0; this.laserHitCooldown = 0;
        }
        draw() {
            ctx.fillStyle = '#4C1D95'; ctx.fillRect(this.x, this.y, this.width, this.height);
            ctx.fillStyle = '#A21CAF'; ctx.fillRect(this.x + this.width * 0.1, this.y + this.height * 0.2, this.width * 0.8, this.height * 0.6);
            ctx.fillStyle = '#F472B6'; ctx.beginPath(); ctx.arc(this.x + this.width/2, this.y + this.height/2, this.width * 0.1, 0, Math.PI * 2); ctx.fill();
            const healthBarWidth = this.width * (this.health / this.maxHealth);
            ctx.fillStyle = '#c0392b'; ctx.fillRect(this.x, this.y - 20, this.width, 10);
            ctx.fillStyle = '#2ecc71'; ctx.fillRect(this.x, this.y - 20, healthBarWidth, 10);
        }
        update() {
            this.x += this.dx;
            if (this.laserHitCooldown > 0) this.laserHitCooldown--;
            if (this.x <= 0 || this.x + this.width >= canvas.width) this.dx *= -1;
            if (Math.random() < 0.015) this.dx *= -1;
            this.shootTimer++; if (this.shootTimer % 50 === 0) this.shoot();
            this.draw();
        }
        shoot() {
            const bulletX = this.x + this.width / 2 - 5; const bulletY = this.y + this.height;
            bossBullets.push(new Bullet(bulletX, bulletY, 10, 20, 5, '#f39c12'));
        }
    }

    class SuperBoss extends Boss {
        constructor(x, y, w, h, speed, health) { super(x, y, w, h, speed, health); }
        draw() {
            ctx.fillStyle = '#1E293B'; ctx.fillRect(this.x, this.y, this.width, this.height);
            ctx.fillStyle = '#EF4444'; ctx.fillRect(this.x + this.width * 0.2, this.y, this.width * 0.6, this.height * 0.8);
            ctx.fillStyle = '#FBBF24'; ctx.fillRect(this.x, this.y + this.height * 0.7, this.width, this.height * 0.3);
            const healthBarWidth = this.width * (this.health / this.maxHealth);
            ctx.fillStyle = '#c0392b'; ctx.fillRect(this.x, this.y - 20, this.width, 10);
            ctx.fillStyle = '#2ecc71'; ctx.fillRect(this.x, this.y - 20, healthBarWidth, 10);
        }
        shoot() {
            const centerX = this.x + this.width / 2, bulletY = this.y + this.height;
            bossBullets.push(new Bullet(centerX - 5, bulletY, 10, 20, 7, '#e74c3c'));
            bossBullets.push(new Bullet(centerX - 50, bulletY, 10, 20, 7, '#e74c3c'));
            bossBullets.push(new Bullet(centerX + 40, bulletY, 10, 20, 7, '#e74c3c'));
        }
    }
    
    class Star {
        constructor(x, y, radius, speed) {
            this.x = x; this.y = y; this.radius = radius; this.speed = speed;
        }
        draw() {
            ctx.fillStyle = 'white'; ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill();
        }
        update() {
            this.y += this.speed; if (this.y > canvas.height) { this.y = 0; this.x = Math.random() * canvas.width; }
        }
    }

    class Coin {
        constructor(x, y, value) {
            this.x = x; this.y = y; this.width = 20; this.height = 20; this.radius = 10;
            this.speed = 2; this.value = value;
        }
        draw() {
            ctx.fillStyle = '#f1c40f'; ctx.beginPath();
            ctx.arc(this.x + this.radius, this.y + this.radius, this.radius, 0, Math.PI * 2);
            ctx.fill(); ctx.fillStyle = '#e67e22'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.font = 'bold 12px Jua'; ctx.fillText('C', this.x + this.radius, this.y + this.radius);
        }
        update() { this.y += this.speed; }
    }

    class HealthPack {
        constructor(x, y) {
            this.x = x; this.y = y; this.width = 20; this.height = 20; this.speed = 2;
        }
        draw() {
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(this.x, this.y + this.width / 2 - 2.5, this.width, 5);
            ctx.fillRect(this.x + this.width / 2 - 2.5, this.y, 5, this.height);
        }
        update() { this.y += this.speed; }
    }

    // --- 게임 초기화 ---
    function init() {
        const container = document.getElementById('game-container');
        canvas.width = container.clientWidth; canvas.height = container.clientHeight;
        score = 0; currentRoundCoins = 0; gameOver = false; gamePaused = false;
        bullets = []; enemies = []; enemyBullets = []; bossBullets = [];
        itemCoins = []; healthPacks = [];
        enemySpawnTimer = 0; shootCooldown = 0; boss = null;
        bossSpawned = false; superBossSpawned = false;
        player = new Player(canvas.width / 2 - 25, canvas.height - 120, 50, 50, 5);
        applySkinAbilities();
        updateHealthDisplay();
        isLaserActive = false; laserEndTime = 0; laserCooldownEndTime = 0; spacebarHoldStart = 0;
        stars = Array.from({ length: 100 }, () => new Star(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 1.5, Math.random() * 0.5 + 0.2));
        scoreDisplay.textContent = `점수: ${score}`;
        updateCoinDisplays();
    }

    function applySkinAbilities() {
        if (!player) return;
        const skinId = equippedSkin;
        // Reset to defaults first
        player.maxHealth = 3;
        player.shootCooldownFrames = 10;
        player.coinMultiplier = 1;
        
        if (skinId === 'green_arrow' || skinId === 'starlight_phantom' || skinId === 'galactic_overlord') {
            player.maxHealth = 5;
        }
        player.health = player.maxHealth;

        if (skinId === 'red_comet' || skinId === 'starlight_phantom' || skinId === 'galactic_overlord') {
            player.shootCooldownFrames = 10 * 0.85; // 15% faster
        }
        if (skinId === 'gold_ship' || skinId === 'galactic_overlord') {
            player.coinMultiplier = 2;
        }
    }

    // --- 게임 루프 ---
    function gameLoop(timestamp) {
        if (gamePaused) { animationFrameId = requestAnimationFrame(gameLoop); return; }
        if (player.health <= 0) gameOver = true;
        if (gameOver) {
            coins += currentRoundCoins; saveGameData();
            cancelAnimationFrame(animationFrameId); showGameOverScreen(); return;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        stars.forEach(star => { star.update(); star.draw(); });
        player.update();

        const now = performance.now();
        if (keys['Space'] && !isLaserActive && now > laserCooldownEndTime) {
            if (spacebarHoldStart === 0) {
                 // This is set on keydown, handled separately now
            } else {
                const holdDuration = now - spacebarHoldStart;
                if (holdDuration > 1000) { // Start charging after 1 sec
                    const chargeTime = holdDuration - 1000;
                    drawLaserChargeBar(chargeTime / 3000); // 3 seconds to fully charge
                    if (chargeTime > 3000) {
                        activateLaser(now);
                    }
                }
            }
        }
        
        if (isLaserActive) {
            if (now > laserEndTime) {
                isLaserActive = false;
                laserCooldownEndTime = now + 10000;
            } else {
                drawLaser();
            }
        }
        
        if (shootCooldown > 0) shootCooldown--;
        
        if (score >= 10000 && bossSpawned && !superBossSpawned && !boss) { superBossSpawned = true; spawnSuperBoss(); }
        else if (score >= 1500 && !bossSpawned) { bossSpawned = true; spawnBoss(); }
        
        [bullets, bossBullets, enemyBullets, itemCoins, healthPacks].forEach(arr => {
            arr.forEach((item, index) => { item.update(); item.draw(); if (item.y > canvas.height) arr.splice(index, 1); });
        });
        if (!boss) { enemySpawnTimer++; if (enemySpawnTimer > 50) { spawnEnemy(); enemySpawnTimer = 0; } }
        enemies.forEach((enemy) => { enemy.update(); enemy.draw(); });
        if (boss) boss.update();
        handleCollisions();
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    // --- 보조 함수들 ---
    function spawnEnemy() {
        if (Math.random() < 0.2) { enemies.push(new Enemy(Math.random() * (canvas.width - 60), -60, 60, 60, 1, 2, '#B91C1C')); }
        else { const size = Math.random() * 20 + 30; enemies.push(new Enemy(Math.random() * (canvas.width - size), -size, size, size, Math.random() * 2 + 1, 1, '#F87171')); }
    }
    function spawnBoss() { boss = new Boss(canvas.width / 2 - 75, 50, 150, 100, 2, 30); }
    function spawnSuperBoss() { boss = new SuperBoss(canvas.width / 2 - 100, 50, 200, 120, 3, 100); }
    function shoot() {
        if(shootCooldown > 0 || isLaserActive) return;
        const bulletX = player.x + player.width / 2 - 2.5; const bulletY = player.y;
        bullets.push(new Bullet(bulletX, bulletY, 5, 15, -10, '#f0e68c'));
        shootCooldown = player.shootCooldownFrames;
    }
    function isColliding(rect1, rect2) {
        if (!rect1 || !rect2) return false;
        return rect1.x < rect2.x + rect2.width && rect1.x + rect1.width > rect2.x && rect1.y < rect2.y + rect2.height && rect1.y + rect1.height > rect2.y;
    }

    function defeatEnemy(enemy, index) {
        const isSuperBoss = enemy instanceof SuperBoss;
        const isBoss = enemy instanceof Boss;
        const isBig = !isBoss && enemy.width > 50;
        
        let scoreGain = 0;
        let coinDrops = [];

        if (isBoss) {
            scoreGain = isSuperBoss ? 10000 : 5000;
            const coinCount = isSuperBoss ? 50 : 25;
            for(let c = 0; c < coinCount; c++) {
                coinDrops.push(new Coin(enemy.x + enemy.width / 2 + (Math.random() - 0.5) * enemy.width, enemy.y + enemy.height/2 + (Math.random() - 0.5) * enemy.height, 20));
            }
            boss = null;
            presentSkillChoice();
        } else {
            scoreGain = isBig ? 250 : 100;
            const coinCount = isBig ? 2 : 1;
            for(let c = 0; c < coinCount; c++) {
                coinDrops.push(new Coin(enemy.x + (Math.random() - 0.5) * 20, enemy.y, 10));
            }
            if (Math.random() < 0.15) {
                healthPacks.push(new HealthPack(enemy.x, enemy.y));
            }
            enemies.splice(index, 1);
        }
        
        score += scoreGain;
        itemCoins.push(...coinDrops);
        scoreDisplay.textContent = `점수: ${score.toLocaleString()}`;
    }

    function handleCollisions() {
        for (let i = enemies.length - 1; i >= 0; i--) if (isColliding(player, enemies[i])) { player.takeDamage(); enemies.splice(i, 1); break; }
        for (let i = enemyBullets.length - 1; i >= 0; i--) if (isColliding(player, enemyBullets[i])) { player.takeDamage(); enemyBullets.splice(i, 1); break; }
        for (let i = bossBullets.length - 1; i >= 0; i--) if (isColliding(player, bossBullets[i])) { player.takeDamage(); bossBullets.splice(i, 1); break; }
        
        for (let i = bullets.length - 1; i >= 0; i--) {
            for (let j = enemies.length - 1; j >= 0; j--) {
                if (bullets[i] && enemies[j] && isColliding(bullets[i], enemies[j])) {
                    enemies[j].health -= player.bulletDamage;
                    if (!player.pierceShot) bullets.splice(i, 1);
                    if (enemies[j].health <= 0) {
                        defeatEnemy(enemies[j], j);
                    }
                    if (!player.pierceShot) break;
                }
            }
        }

        if (boss) {
            for (let i = bullets.length - 1; i >= 0; i--) {
                if (bullets[i] && isColliding(bullets[i], boss)) {
                    boss.health -= player.bulletDamage;
                    if (!player.pierceShot) bullets.splice(i, 1);
                    if (boss.health <= 0) {
                        defeatEnemy(boss);
                    }
                    if (!player.pierceShot) break;
                }
            }
        }

        for (let i = itemCoins.length - 1; i >= 0; i--) if (isColliding(player, itemCoins[i])) { currentRoundCoins += itemCoins[i].value * player.coinMultiplier; updateCoinDisplays(); itemCoins.splice(i, 1); }
        for (let i = healthPacks.length - 1; i >= 0; i--) if (isColliding(player, healthPacks[i])) { if (player.health < player.maxHealth) { player.health++; updateHealthDisplay(); } healthPacks.splice(i, 1); }

        if (isLaserActive) {
            const laserRect = { x: player.x, y: 0, width: player.width, height: player.y };
            
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (isColliding(laserRect, enemy) && enemy.laserHitCooldown === 0) {
                    enemy.health -= 0.5; enemy.laserHitCooldown = 5;
                    if (enemy.health <= 0) defeatEnemy(enemy, i);
                }
            }
            if (boss && isColliding(laserRect, boss) && boss.laserHitCooldown === 0) {
                boss.health -= 0.5; boss.laserHitCooldown = 5;
                if (boss.health <= 0) defeatEnemy(boss);
            }
        }
    }
    
    function activateLaser(now) {
        isLaserActive = true; laserEndTime = now + 10000; spacebarHoldStart = 0;
    }

    function drawLaser() {
        ctx.fillStyle = 'rgba(0, 150, 255, 0.5)';
        ctx.fillRect(player.x, 0, player.width, player.y);
        ctx.fillStyle = 'white';
        ctx.fillRect(player.x + player.width/2 - 2, 0, 4, player.y);
    }
    
    function drawLaserChargeBar(ratio) {
        if (ratio > 1) ratio = 1;
        const barY = player.y + player.height + 10;
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.fillRect(player.x, barY, player.width, 10);
        ctx.fillStyle = '#0096FF';
        ctx.fillRect(player.x, barY, player.width * ratio, 10);
    }

    function updateHealthDisplay() {
        healthDisplay.innerHTML = '';
        for (let i = 0; i < player.maxHealth; i++) healthDisplay.innerHTML += i < player.health ? '❤️' : '🖤';
    }
    function showGameOverScreen() {
        finalScoreDisplay.textContent = `최종 점수: ${score.toLocaleString()}`;
        earnedCoinsDisplay.textContent = `획득 코인: ${currentRoundCoins.toLocaleString()} 💰`;
        gameOverScreen.classList.remove('hidden');
        mobileControls.classList.add('hidden');
        saveScoreButton.textContent = '랭킹 저장';
        saveScoreButton.disabled = false;
    }
    function getRankings() { return JSON.parse(localStorage.getItem('airplaneShooterRankings') || '[]'); }
    function saveScore() {
        const name = nameInput.value.trim(); if (!name) return;
        const rankings = getRankings(); rankings.push({ name, score });
        rankings.sort((a, b) => b.score - a.score);
        localStorage.setItem('airplaneShooterRankings', JSON.stringify(rankings.slice(0, 10)));
        saveScoreButton.textContent = '저장됨';
        saveScoreButton.disabled = true;
    }
    function showRankingScreen() {
        allScreens.forEach(s => s.classList.add('hidden'));
        rankingScreen.classList.remove('hidden');
        const rankings = getRankings(); rankingList.innerHTML = '';
        if (rankings.length === 0) { rankingList.innerHTML = '<li>아직 랭킹이 없습니다.</li>'; }
        else { rankings.forEach(entry => { const li = document.createElement('li'); li.className = "text-lg sm:text-2xl"; li.textContent = `${entry.name}: ${entry.score.toLocaleString()}점`; rankingList.appendChild(li); }); }
    }

    function presentSkillChoice() {
        gamePaused = true;
        skillChoicesContainer.innerHTML = '';
        let availableSkills = [...skills];
        for(let i = 0; i < 3; i++) {
            if (availableSkills.length === 0) break;
            const randomIndex = Math.floor(Math.random() * availableSkills.length);
            const skill = availableSkills.splice(randomIndex, 1)[0];
            const card = document.createElement('div');
            card.className = 'skill-card';
            card.innerHTML = `<h3 class="text-2xl font-bold mb-2">${skill.name}</h3><p>${skill.description}</p>`;
            card.onclick = () => applySkill(skill.id);
            skillChoicesContainer.appendChild(card);
        }
        skillChoiceScreen.classList.remove('hidden');
    }
    function applySkill(skillId) {
        switch (skillId) {
            case 'damage_up': player.bulletDamage *= 2; break;
            case 'fire_rate_up': player.shootCooldownFrames /= 2; break;
            case 'shield': player.hasShield = true; break;
            case 'pierce_shot': player.pierceShot = true; break;
            case 'extra_life': player.maxHealth++; player.health++; updateHealthDisplay(); break;
        }
        skillChoiceScreen.classList.add('hidden');
        gamePaused = false;
    }

    function populateShop() {
        skinList.innerHTML = '';
        skins.forEach(skin => {
            const isOwned = ownedSkins.includes(skin.id), isEquipped = equippedSkin === skin.id;
            const item = document.createElement('div'); item.className = 'skin-item';
            const previewCanvas = document.createElement('canvas');
            previewCanvas.className = 'skin-preview'; previewCanvas.width = 100; previewCanvas.height = 100;
            skin.draw(previewCanvas.getContext('2d'), 25, 25, 50, 50);
            const name = document.createElement('p'); name.textContent = skin.name;
            const button = document.createElement('button');
            button.className = 'skin-button px-4 py-2 rounded-lg text-white font-bold shadow-lg';
            if (isEquipped) { button.textContent = '장착중'; button.disabled = true; button.classList.add('bg-gray-500'); }
            else if (isOwned) { button.textContent = '장착'; button.classList.add('bg-green-600', 'hover:bg-green-700'); button.onclick = () => { equippedSkin = skin.id; saveGameData(); populateShop(); }; }
            else { button.textContent = `구매 (💰${skin.price.toLocaleString()})`; button.classList.add('bg-blue-600', 'hover:bg-blue-700'); button.onclick = () => { if (coins >= skin.price) { coins -= skin.price; ownedSkins.push(skin.id); equippedSkin = skin.id; saveGameData(); updateCoinDisplays(); populateShop(); } else { alert('코인이 부족합니다!'); } }; }
            item.appendChild(previewCanvas); item.appendChild(name); item.appendChild(button);
            skinList.appendChild(item);
        });
    }

    // --- 이벤트 리스너 ---
    function handleShootStart(e) {
        e.preventDefault();
        keys['Space'] = true;
        if (spacebarHoldStart === 0) {
            spacebarHoldStart = performance.now();
        }
    }
    function handleShootEnd(e) {
        e.preventDefault();
        keys['Space'] = false;
        if (spacebarHoldStart > 0) {
            const holdDuration = performance.now() - spacebarHoldStart;
            if (holdDuration < 1000) { // Only shoot if held for less than a second
                shoot();
            }
        }
        spacebarHoldStart = 0;
    }

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') handleShootStart(e);
        else keys[e.code] = true;
    });
    window.addEventListener('keyup', (e) => {
        if (e.code === 'Space') handleShootEnd(e);
        else keys[e.code] = false;
    });
    
    startButton.addEventListener('click', () => { lobbyScreen.classList.add('hidden'); gameStats.classList.remove('hidden'); mobileControls.classList.remove('hidden'); init(); requestAnimationFrame(gameLoop); });
    restartButton.addEventListener('click', () => { gameOverScreen.classList.add('hidden'); gameStats.classList.remove('hidden'); mobileControls.classList.remove('hidden'); init(); requestAnimationFrame(gameLoop); });
    saveScoreButton.addEventListener('click', saveScore);
    rankingButtonMain.addEventListener('click', showRankingScreen);
    shopButton.addEventListener('click', () => { lobbyScreen.classList.add('hidden'); shopScreen.classList.remove('hidden'); populateShop(); });
    backToLobbyButton.addEventListener('click', () => { shopScreen.classList.add('hidden'); lobbyScreen.classList.remove('hidden'); mobileControls.classList.add('hidden'); updateCoinDisplays(); });
    playAgainButton.addEventListener('click', () => { rankingScreen.classList.add('hidden'); gameStats.classList.remove('hidden'); mobileControls.classList.remove('hidden'); init(); requestAnimationFrame(gameLoop); });
    mainMenuButton.addEventListener('click', () => { rankingScreen.classList.add('hidden'); lobbyScreen.classList.remove('hidden'); mobileControls.classList.add('hidden');});
    goToShopButton.addEventListener('click', () => { gameOverScreen.classList.add('hidden'); shopScreen.classList.remove('hidden'); populateShop(); });
    goToLobbyButton.addEventListener('click', () => { gameOverScreen.classList.add('hidden'); lobbyScreen.classList.remove('hidden');});
    confirmNameButton.addEventListener('click', confirmName);
    
    // 모바일 터치 이벤트
    leftButton.addEventListener('touchstart', (e) => { e.preventDefault(); keys['ArrowLeft'] = true; });
    leftButton.addEventListener('touchend', (e) => { e.preventDefault(); keys['ArrowLeft'] = false; });
    rightButton.addEventListener('touchstart', (e) => { e.preventDefault(); keys['ArrowRight'] = true; });
    rightButton.addEventListener('touchend', (e) => { e.preventDefault(); keys['ArrowRight'] = false; });
    shootButton.addEventListener('touchstart', handleShootStart);
    shootButton.addEventListener('touchend', handleShootEnd);

    window.addEventListener('resize', () => { if (!lobbyScreen.classList.contains('hidden')) { const c = document.getElementById('game-container'); canvas.width = c.clientWidth; canvas.height = c.clientHeight; }});
    
    loadGameData();
</script>

</body>
</html>

